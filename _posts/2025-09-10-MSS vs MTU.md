---
layout: post
title: "MSS vs MTU"
categories: [네트워크, 패킷, MSS, MTU]
author: cotes
published: true
---



### MTU (Maximum Transmission Unit)
정의: MTU는 네트워크 계층에서 전송할 수 있는 최대 패킷 크기를 의미합니다. 이는 데이터 링크 계층에서 설정되며, 일반적으로 이더넷의 경우 1500byte 입니다.

중요성: MTU는 네트워크 성능에 큰 영향을 미칩니다. 너무 작은 MTU는 패킷 수를 증가시켜 오버헤드를 증가시키고, 너무 큰 MTU는 네트워크 장비나 경로상의 제한으로 인해 패킷 손실이나 단편화(fragmentaion)를 유발할 수 있습니다.

다시, MTU가 크면 단위당 헤더 오버헤드가 줄어들어 대량 전송 시 처리량(throughput)이 증가하고, MTU가 작으면 작은 패킷으로 실시간 애플리케이션의 지연(latency)를 줄일 수 있습니다.

--------------------------------------

### MSS (Maximum Segment Size)
정의: MSS는 TCP 연결에서 한 번에 전송할 수 있는 최대 크기를 의미합니다. 이는 IP 헤더와 TCP 헤더를 제외한 순수 데이터 부분의 크기를 나타냅니다.

중요성: MSS는 TCP 연결의 효율성에 영향을 미칩니다. 너무 큰 MSS는 패킷이 MTU를 초과하여 단편화되게 만들 수 있으며, 너무 작은 MSS는 오버헤드를 증가시킬 수 있습니다.

--------------------------------------------------

### MTU와 MSS의 관계

| 항목 | MTU(byte) | MSS(byte) | 설명 |
|----------|--------|----------|---------|
| 이더넷 표준 | 1500 | 1460 | 이더넷 헤더(14byte)와 IP 헤더(20byte), TCP 헤더(20byte)를 제외한 값|
| GRE 터널링 | 1476 | 1436 | GRE 헤더(24byte)를 제외한 값|
| VXLAN 캡슐화 | 1500 | 1450 | VXLAN 헤더(50byte)를 제외한 값|

GRE와 VXLAN과 같은 터널링 기술은 추가적인 헤더를 삽입하므로, 이를 고려하여 MTU와 MSS를 설정해야 합니다.

--------------------------------------------------

![BitOperations](VXlanHeader.PNG)


### Packet 단편화(Fragmentation) 
Packet 단편화는 송신 호스트나 경로상의 라우터가 MTU보다 큰 Ipv4 Packet을 여러 조각으로 나누어 전송하는 과정입니다. 기본적으로 Ipv4에서는 DF(Dont Fragment) 비트가 0이면 라우터가 MTU에 맞게 패킷을 분할하고, 비트가 1이면 분할 없이 패킷을 폐기하며 ICMP "Packet too big" 메시지를 송신자에게 보냅니다. 분할된 각 조각에는 원본 헤더가 복사되어 들어가며, 최종 목적지에서 모든 조각을 모아 재조립합니다.

- 발생 조건: 송신 패킷이 경로상의 MTU보다 클 때 발생합니다. 예를 들어 MTU가 1500byte인 네트워크에서 2000byte 패킷이 오면, 기본 DF=0 상태라면 라우터가 두 개의 조각(각각 1500byte 미만)으로 분할합니다. DF=1인 경우에는 라우터가 패킷을 분할하지 않고 폐기한뒤 ICMP 오류로 알려줍니다.

- 성능 영향: 단편화된 패킷은 각 조각마다 헤더가 추가되어 오버헤드가 커지고, 목적지에서 재조립하는 비용이 발생하여 지연이 늘어납니다. 또한, 조각이 순서가 바뀌거나 일부 손실되면 원본 패킷 전체를 재전송해야해 네트워크 효율이 떨어집니다. 일부 방화벽/장비는 분할된 패킷 처리에 제한이 있어 호환성 문제가 생기기도 합니다.

### VXLAN (Virtual eXtensible LAN)
VXLAN은 데이터센터 등에서 여러 가상 네트워크(VLAN)를 Layer3 위에 확장하기 위해 고안된 오버레이 기술입니다. 가상 네트워크마다 24바이트의 VNI(VXLAN Network Identifier)가 할당되어 최대 1600만개 이상의 세그먼트를 지원합니다. VXLAN VTEP(VXLAN Tunnel Endpoint)는 내부 이더넷 프레임을 UDP(기본 포트 4789)로 캡슐화하야 전송합니다. 이 과정에서 원본 프레임에 50byte의 오버헤드(외부 Ethernet 14 + IP 20 + UDP 8 + VXLAN 8)가 추가됩니다.

| 구분          | MTU                                        | IP 단편화                                  | VXLAN                                                        |
| ----------- | ------------------------------------------ | --------------------------------------- | ------------------------------------------------------------ |
| **정의**      | 네트워크에서 허용되는 최대 패킷 크기<br> (예: 이더넷 기본 1500B) | IP 계층에서 MTU보다 큰 패킷을 작은 조각으로 나누는 것       | L2 프레임을 L3 네트워크로 캡슐화하여 가상 네트워크를 만드는 오버레이 기술                  |
| **계층**      | 주로 데이터 링크 계층(예: Ethernet)                  | 네트워크 계층(IP/IPv4)                        | 오버레이: 물리 Layer3(underlay) 위에서 Layer2(overlay)를 가상화           |
| **기본/오버헤드** | Ethernet 기본 1500B, 점보 최대 9000B             | 조각 단위는 MTU (예: 1500B)                   | VXLAN 캡슐화 오버헤드 약 50B (Ethernet 14 + IP 20 + UDP 8 + VXLAN 8) |
| **발생 조건**   | 물리 링크 간 MTU 불일치 또는 부적절한 MTU 설정             | 송신 패킷 크기가 경로 MTU 초과 시 (DF=0 상태)         | 캡슐화된 패킷 크기(예: 1550B)가 물리 MTU(예: 1500B)보다 클 때                 |
| **영향/특징**   | 큰 MTU: 헤더 오버헤드 ↓, 처리량 ↑<br>작은 MTU: 지연 ↓    | 재조립으로 인한 CPU 부하 및 지연↑<br>손실 시 전체 재전송 발생 | 물리 MTU를 늘려야 함 (점보프레임 권장)<br>기존 VLAN(4094)보다 확장성 ↑ (16M 지원)   |

위 내용을 바탕으로, 실제 네트워크를 설계할 때는 MTU 설정을 경로상의 모든 장비가 감당할 수 있는 크기로 맞추고, DF 비트/PMTUD를 활용해 단편화를 최소화해야 합니다. 또한 VXLAN 같은 오버레이 기술을 사용할 경우에는 추가된 헤더만큼 물리 네트워크의 MTU를 충분히 확보해야 안정적인 데이터 전송이 가능합니다
juniper.net
networkworld.com
.

출처: MTU와 단편화 및 VXLAN 관련 공식 문서와 기술 블로그 자료
louis-j.tistory.com
networkworld.com
juniper.net
juniper.net
. (각 수치는 해당 자료에서 확인할 수 있습니다.)


### 실무에서 발생할법한 시나리오 다섯가지

### 시나리오 1: 기본 이더넷 네트워크
상황: 데이터센터에서 일반 이더넷 스위치(1500byte MTU)를 사용하는 경우

- MTU를 기본 1500byte로 설정하고, TCP MSS를 1460byte로 설정
- TCP 세션에서 단편화 발생을 최소화
- MTU보다 큰 패킷이 필요하면 정보 프레임(9000byte)사용 가능

결과: 패킷 단편화 최소화 -> 네트워크 성능 안전

--------------------------------------------------

### 시나리오 2: 터널링 (GRE, VXLAN)
상황: 서버간 VXLAN Overlay 사용, 기본 물리 MTU 1500byte

- VXLAN 캡슐화 오버헤드 약 50byte를 고려하여 물리 MTU를 1550byte 이상으로 설정
- TCP MSS를 1450byte로 조정하여 단편화 방지
- GRE 터널 사용시, GRE 헤더 크기 24byte를 추가하여 MTU 계산

결과: VXLAN/Tunneling 환경에서도 패킷 손실과 단편화 최소화

-----------------------------------------------------

### 시나리오 3: 인터넷/관역망(MPLS) 연결
상황: 본사와 지사간 MPLS 연결, 경로 MTU가 불명확

- DF(Don't Fragment) 비트를 1로 설정하고 PMTUD(Path MTU Discovery) 사용
- MTU 초과시 ICMP "Packet too Big"메시지를 통해 최적 MTU 자동 조정
- MSS를 PMTUD 계산 결과에 맞춰 TCP 세션 조정

결과: WAN 경로에서 불필요한 단편화 없이 안정적인 TCP 연결 유지

-----------------------------------------------------
### 시나리오 4: 클라우드 환경(AWS, Azure, GCP)
상황: 클라우드 VM간 VXLAN 기반 가상 네트워크 구성

- 클라우드 내부 가상 네트워크 MTU 확인(ex: AWS ENI 기본 9001Byte)
- VXLAN 캡슐화 오버헤드 포함하여 MTU 설정
- MSS를 MTU-Header-Size로 설정하여 TCP 연결 최적화

결과: 클라우드 환경에서 VXLAN 트래픽 안정적 전송

| 시나리오 | 핵심 TIP | MTU/MSS 설정 |
| VXLAN / GRE 터널 | 캡슐화 오버헤드 반영 | MTU >= 1550 byte / MSS 1450 byte |
| WAN / MPLS | PMTUD + DF 비트 | 최적 MTU 탐지 / MSS 조정 |
| 클라우드 가상 네트워크 | 클라우드 MTU 확인, VXLAN 반영 | MTU = 클라우드 MTU - 오버헤드 / MSS 조정 |

![alt text](image-3.png)

